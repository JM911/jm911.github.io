---
layout: single
title:  "Spinning Donut 구현 (3)"
categories: coding
tag: [cpp]
toc: true
---

# 콘솔 창 관련 처리

도넛에 대한 수식을 계산하기 전에 우선 귀찮은 작업부터 끝내자.  

## 시간의 흐름 표현
움직이는 물체를 콘솔창에서 애니메이션처럼 표현하기 위해서는 일정 시간 간격으로 화면을 업데이트 해줘야 한다.  
콘솔창에서 시간의 흐름을 표현하기 위해 <Windows.h> 헤더의 `Sleep()` 함수를 사용하는데, 이 함수는 Windows 상에서 지정된 시간을 기다린 후 다음 작업으로 넘어가는 기능을 수행한다.  
앞에서 작성한 코드 핵심부를 While 문으로 묶어 다음 반복 작업을 실행하기 전에 `Sleep()`으로 시간 간격을 두는 방식이면 된다.  
물론 그냥 시간 지연만 추가하면 아래처럼 돼버린다.  

![image](https://jm911.github.io/assets/images/240515/1.gif)

테스트 용으로 일단 업데이트 간격은 30ms이며 구체 반지름이 0으로 시작하고 업데이트마다 0.2씩 커지도록 만들어봤다.  
위 사진처럼 앞쪽 출력 결과물이 남아서 위로 스크롤되는 것이 보인다.  
당연하게도 다음 프레임을 출력하기 전에 이전 프레임 내용을 싹 날려야 갈끔하게 보일 것이다.  


## 콘솔창 클리어

이전 프레임 결과물을 지우는 방법을 몇 가지 찾아봤는데, 내가 사용한 방법은 `system("cls")` 호출이다.  
`system()`은 인자로 전달된 문자열을 콘솔창에 입력하는 것처럼 동작한다.  
여기서 "cls" 는 clear screen의 약자라고 하는데, 이 명령으로 콘솔창이 깨끗하게 지워지기 때문에 지금 상황에 가장 알맞은 기능이다.  

문제는 해당 기능을 사용하면 결과가 다음처럼 나온다.  

![image](https://jm911.github.io/assets/images/240515/2.gif)  

화면이 지워진 후 모든 출력 결과가 나오기까지 잠깐의 딜레이가 있어 화면이 깜박거린다.  
딜레이를 최대한 줄이기 위해 픽셀 연산 결과를 바로 출력하지 않고 배열에 모아두었다가 출력 직전에 화면을 지우고 출력해도 이 정도다.  
그래서 다른 사람들이 만드는 Spinning donut에서는 어떤 방법을 사용하는지 찾아봤다.  

Spinning Donut으로 가장 유명한 코드를 찾아보니 이상한 문자를 출력하여 출력 커서를 맨 앞으로 되돌리는 것을 발견했다.  
일단 왜 이런 방법인지는 둘째치고 아예 처음 보는 해괴한 방법이라 원리를 조금 조사해봤다.  
  

## ANSI Escape Code

ANSI Escape Code 란 터미널을 제어하는 데 사용되는 표준이라고 한다.  
동작 방식을 정확하게 이해하지는 못했지만, 특정 코드를 출력하면 콘솔 창에서의 원하는 조작을 할 수 있게 해주는 것 같다.  
  
사용 방법은 `\x1B` 또는 `\033` 로 ESC에 해당하는 아스키 코드로 시작한 뒤 특정 문자 조합을 붙여 `printf()`로 출력하면 된다.  
커서 조작, 색상 등 주로 사용하는 대부분의 기능은 `[`를 사용하는 CSI(Control Sequence Introducer)로 시작한다고 한다.  
예를 들어, 커서를 위로 이동하고 싶으면 `printf("\x1B[A")`를 호출하는 식이다.  
참고로 ANSI Escape Code 관련 명령어는 대부분 [여기](https://gist.github.com/fnky/458719343aabd01cfb17a3a4f7296797)서 찾을 수 있다.  
  
어쨌든 이 방식으로 내가 사용한 기능은 아래 3개이다.  
1. `printf("\x1b[2J");` - 화면 전체 지우기
    - 앞에서 사용한 화면 지우기와 동일한 기능
    - 이번엔 매 프레임마다 지운 게 아니라 로직을 본격적으로 시작하기 전 한 번만 호출하여 깔끔하게 시작하는 용도로 사용했다.
2. `printf("\x1b[?25l");` - 커서 숨기기
    - 마찬가지로 로직 시작 전 맨 처음 호출
3. `printf("\x1b[H");` - 커서를 (0, 0)으로 이동
    - 매 프레임마다 호출
  
기능적으로는 3번에서 사용한 방법이 핵심인데, 화면을 지우지 않고 이전 결과물을 남겨둔 채로 새로운 프레임 결과물로 덮어씌우는 방식이다.  
화면을 완전히 지우지 않고 직전 프레임의 결과물을 남겨놓고 부드러운 전환으로 보이게 만드는 것이다.  
물론 화면 전환이 급격하면 마치 테어링 현상처럼 윗줄부터 업데이트되는 모습이 적나라하게 보이겠지만... 그런 출력이 필요한 상황은 아니니까 넘어가도 될 것 같다.  
  
최종 결과물은 다음과 같다.  
  
![image](https://jm911.github.io/assets/images/240515/3.gif)  

원하는 형태의 만족스러운 결과물이 나왔다. 이제 진짜 도넛 수식만 정리해서 표현하면 끝날 것 같다.  


## 추가 테스트

빛 방향을 회전하게 만들어 추가 테스트 진행  
![image](https://jm911.github.io/assets/images/240515/4.gif){: width="45%" height="45%"}
![image](https://jm911.github.io/assets/images/240515/5.gif){: width="45%" height="45%"}


최종 코드 참고: [링크](https://jm911.github.io/assets/images/240515/SpinningDonut.cpp)



